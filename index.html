<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <title>Shatter Ultra-Reactive V19</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/selfie_segmentation.js" crossorigin="anonymous"></script>
    <style>
        :root { --accent: #00d4ff; --bg: #0a0a0a; --fx: #ff0050; }
        body { background: var(--bg); color: white; font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        .sidebar { width: 320px; background: #111; border-right: 1px solid #333; padding: 15px; display: flex; flex-direction: column; gap: 10px; overflow-y: auto; }
        .main { flex-grow: 1; display: flex; justify-content: center; align-items: center; background: #000; position: relative; }
        #container { height: 90vh; aspect-ratio: 9/16; position: relative; border: 2px solid #444; z-index: 2; }
        canvas { width: 100%; height: 100%; }
        .card { background: #1a1a1a; padding: 12px; border-radius: 8px; border: 1px solid #333; margin-bottom: 10px; }
        h3 { font-size: 11px; margin: 0 0 10px; color: var(--accent); text-transform: uppercase; letter-spacing: 1px; }
        input, button, select { width: 100%; background: #000; border: 1px solid #444; color: white; padding: 8px; border-radius: 4px; font-size: 11px; margin-bottom: 5px; }
        .btn-on { background: #2ed573 !important; color: #000; font-weight: bold; }
        .btn-off { background: #ff4757 !important; color: white; }
        label { font-size: 10px; color: #888; display: block; margin-top: 5px; }
        .flash-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: white; opacity: 0; pointer-events: none; z-index: 1; }
    </style>
</head>
<body>

<div id="flash" class="flash-layer"></div>

<div class="sidebar">
    <div class="card">
        <h3>1. Surse Intrare</h3>
        <button onclick="startCamera()" id="camBtn">START CAMERĂ</button>
        <button onclick="toggleDesktopAudio()" id="deskBtn">AUDIO SISTEM: OFF</button>
        <button onclick="toggleMic()" id="micBtn">MICROFON: OFF</button>
        <button onclick="aiActive=!aiActive">AI CUT-OUT: ON/OFF</button>
    </div>

    <div class="card" style="border-left: 3px solid var(--fx);">
        <h3>2. FX Shatter & Glitch</h3>
        <label>Sensibilitate Sound</label>
        <input type="range" id="audioSens" min="0" max="300" value="150">
        
        <label>Putere Spargere</label>
        <input type="range" id="shatterPower" min="0" max="500" value="200">
        
        <label>Nr. Fragmente</label>
        <input type="range" id="shards" min="1" max="25" value="10">
        
        <label>Linii Glitch (Contur)</label>
        <input type="range" id="edge" min="0" max="100" value="40">

        <label>Screen Flash (Bass)</label>
        <input type="range" id="flashPwr" min="0" max="100" value="0">
        
        <button style="background:#555" onclick="resetAll()">RESET TOTAL (ZERO)</button>
    </div>
    
    <div style="font-size:9px; color:#444">Apasă ENTER pentru activare manuală FX</div>
</div>

<div class="main">
    <div id="container">
        <canvas id="out"></canvas>
    </div>
</div>

<video id="vid" autoplay muted playsinline style="display:none"></video>

<script>
    const video = document.getElementById('vid');
    const canvas = document.getElementById('out');
    const ctx = canvas.getContext('2d');
    const flashEl = document.getElementById('flash');
    
    let aiActive = false, fxManual = false;
    let audioCtx, analyser, dataArray;
    let micStream, deskStream;
    const W = 1080, H = 1920;

    const selfie = new SelfieSegmentation({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/${file}`});
    selfie.setOptions({ modelSelection: 1 });
    selfie.onResults(draw);

    async function startCamera() {
        const s = await navigator.mediaDevices.getUserMedia({video: {width: 1280, height: 720}});
        video.srcObject = s;
        document.getElementById('camBtn').classList.add('btn-on');
        if(!audioCtx) setupAudio();
        setInterval(() => { if(video.readyState >= 2) selfie.send({image: video}); }, 40);
    }

    function setupAudio() {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        analyser = audioCtx.createAnalyser();
        analyser.fftSize = 256;
        dataArray = new Uint8Array(analyser.frequencyBinCount);
    }

    async function toggleMic() {
        if(!micStream) {
            micStream = await navigator.mediaDevices.getUserMedia({audio: true});
            const s = audioCtx.createMediaStreamSource(micStream);
            s.connect(analyser);
            document.getElementById('micBtn').className = 'btn-on';
            document.getElementById('micBtn').innerText = 'MICROFON: ACTIV';
        } else {
            micStream.getAudioTracks()[0].enabled = !micStream.getAudioTracks()[0].enabled;
            document.getElementById('micBtn').className = micStream.getAudioTracks()[0].enabled ? 'btn-on' : 'btn-off';
        }
    }

    async function toggleDesktopAudio() {
        try {
            deskStream = await navigator.mediaDevices.getDisplayMedia({video: true, audio: true});
            const s = audioCtx.createMediaStreamSource(deskStream);
            s.connect(analyser);
            document.getElementById('deskBtn').className = 'btn-on';
            document.getElementById('deskBtn').innerText = 'AUDIO SISTEM: ACTIV';
        } catch(e) { alert("Selectează 'Share Audio' când alegi fereastra!"); }
    }

    function resetAll() {
        const ids = ['audioSens','shatterPower','shards','edge','flashPwr'];
        ids.forEach(id => document.getElementById(id).value = 0);
    }

    function draw(res) {
        canvas.width = W; canvas.height = H;
        ctx.fillStyle = "#00ff00"; ctx.fillRect(0, 0, W, H);

        let vol = 0;
        if(analyser) {
            analyser.getByteFrequencyData(dataArray);
            vol = dataArray.reduce((a,b) => a+b) / dataArray.length;
        }

        const sens = document.getElementById('audioSens').value / 100;
        const pwr = document.getElementById('shatterPower').value * (vol/128) * sens;
        const shd = document.getElementById('shards').value;
        const edg = document.getElementById('edge').value;
        const flsh = document.getElementById('flashPwr').value;

        // Screen Flash logic
        if(vol * sens > 70) flashEl.style.opacity = flsh / 100;
        else flashEl.style.opacity = 0;

        let w = W * 0.9, h = (video.videoHeight / video.videoWidth) * w;
        let x = (W-w)/2, y = (H-h)/2;

        if(fxManual || vol * sens > 20) {
            for(let i=0; i<shd; i++) {
                ctx.save();
                ctx.globalAlpha = 0.15;
                const tx = Math.sin(Date.now()*0.01 + i) * pwr;
                render(res, x + tx, y, w, h, edg/2);
                ctx.restore();
            }
        }
        render(res, x, y, w, h, (fxManual || vol*sens > 20) ? edg : 0);
    }

    function render(res, x, y, w, h, glow) {
        ctx.save();
        if(glow > 0) { ctx.shadowBlur = glow; ctx.shadowColor = "white"; }
        if(aiActive && res.segmentationMask) {
            const t = document.createElement('canvas'); t.width = W; t.height = H;
            const tc = t.getContext('2d');
            tc.drawImage(res.image, x, y, w, h);
            tc.globalCompositeOperation = 'destination-in';
            tc.drawImage(res.segmentationMask, x, y, w, h);
            ctx.drawImage(t, 0, 0);
        } else if(video.readyState >= 2) {
            ctx.drawImage(video, x, y, w, h);
        }
        ctx.restore();
    }

    window.onkeydown = (e) => { if(e.key === 'Enter') fxManual = !fxManual; };
</script>
</body>
</html>
