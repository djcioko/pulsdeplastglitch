<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <title>Bass Shake V30 - No White Flash</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/selfie_segmentation.js" crossorigin="anonymous"></script>
    <style>
        :root { --accent: #00d4ff; --bg: #050505; --fx: #ff0050; }
        body { background: var(--bg); color: white; font-family: sans-serif; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        .sidebar { width: 320px; background: #111; border-right: 1px solid #333; padding: 15px; display: flex; flex-direction: column; gap: 10px; overflow-y: auto; z-index: 20; }
        .main { flex-grow: 1; display: flex; justify-content: center; align-items: center; background: #000; }
        #container { height: 92vh; aspect-ratio: 9/16; border: 2px solid #333; position: relative; background: #000; overflow: hidden; }
        canvas { width: 100%; height: 100%; position: absolute; }
        .card { background: #1a1a1a; padding: 12px; border-radius: 8px; border: 1px solid #333; margin-bottom: 5px; }
        h3 { font-size: 10px; margin: 0 0 10px; color: var(--accent); text-transform: uppercase; }
        button { width: 100%; padding: 10px; border-radius: 4px; border: none; font-weight: bold; cursor: pointer; margin-bottom: 5px; }
        .btn-audio { background: #00d4ff; color: black; }
        label { font-size: 10px; color: #888; display: block; margin-top: 5px; }
        input[type="range"] { width: 100%; }
        .vu-bass { height: 4px; background: #333; border-radius: 2px; margin-top: 5px; overflow: hidden; }
        #vuFill { height: 100%; width: 0%; background: var(--fx); transition: width 0.1s; }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="card">
        <h3>1. ACTIVARE</h3>
        <button onclick="startCamera()" style="background:#2ed573">CAMERA OK</button>
        <button class="btn-audio" id="micBtn" onclick="initAudio()">START AUDIO (BASS DETECTION)</button>
        <button onclick="aiActive=!aiActive">AI CUT-OUT ON/OFF</button>
    </div>

    <div class="card" style="border-left: 3px solid var(--fx)">
        <h3>2. BASS FX CONTROL</h3>
        <div class="vu-bass"><div id="vuFill"></div></div>
        <label>Sensibilitate Bass (Prag)</label>
        <input type="range" id="micSens" min="0" max="255" value="50" oninput="saveSet()">
        
        <label>Intensitate Tremur (Shake)</label>
        <input type="range" id="shakeInt" min="0" max="50" value="15" oninput="saveSet()">
        
        <label>Viteza Deplasare (ENTER)</label>
        <input type="range" id="moveSpd" min="1" max="100" value="20" oninput="saveSet()">
    </div>

    <div class="card">
        <h3>3. SISTEM</h3>
        <button onclick="localStorage.clear(); location.reload();" style="font-size:9px;">RESET MEMORIE</button>
    </div>
</div>

<div class="main">
    <div id="container"><canvas id="out"></canvas></div>
</div>

<video id="vid" autoplay muted playsinline style="display:none"></video>

<script>
    const video = document.getElementById('vid');
    const canvas = document.getElementById('out');
    const ctx = canvas.getContext('2d');
    let aiActive = false, fxForced = false, micActive = false;
    let audioCtx, analyser, dataArray;
    const W = 1080, H = 1920;

    const selfie = new SelfieSegmentation({locateFile: (f) => `https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/${f}`});
    selfie.setOptions({ modelSelection: 1 });
    selfie.onResults(draw);

    window.onload = () => {
        const saved = JSON.parse(localStorage.getItem('fx_v30_prefs') || '{}');
        for(let id in saved) { if(document.getElementById(id)) document.getElementById(id).value = saved[id]; }
    };

    function saveSet() {
        const settings = {};
        ['micSens','shakeInt','moveSpd'].forEach(id => { settings[id] = document.getElementById(id).value; });
        localStorage.setItem('fx_v30_prefs', JSON.stringify(settings));
    }

    async function startCamera() {
        const s = await navigator.mediaDevices.getUserMedia({ video: { width: 1280, height: 720 } });
        video.srcObject = s; video.onloadedmetadata = () => { video.play(); loop(); };
    }

    async function initAudio() {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const s = await navigator.mediaDevices.getUserMedia({ audio: true });
        analyser = audioCtx.createAnalyser();
        analyser.fftSize = 1024; // Rezoluție mai mare pentru frecvențe
        dataArray = new Uint8Array(analyser.frequencyBinCount);
        audioCtx.createMediaStreamSource(s).connect(analyser);
        micActive = true;
        document.getElementById('micBtn').style.background = "#2ed573";
    }

    function loop() {
        if (aiActive && video.readyState >= 2) { selfie.send({image: video}); } 
        else { draw({}); }
        requestAnimationFrame(loop);
    }

    function draw(res) {
        canvas.width = W; canvas.height = H;
        ctx.fillStyle = "#000"; ctx.fillRect(0, 0, W, H);

        let bassVal = 0;
        if (micActive && analyser) {
            analyser.getByteFrequencyData(dataArray);
            // Calculăm media doar pentru primele 10 benzi (Bass: 20-150Hz)
            for(let i=0; i<10; i++) { bassVal += dataArray[i]; }
            bassVal /= 10;
        }

        const sens = document.getElementById('micSens').value;
        const sInt = document.getElementById('shakeInt').value;
        const spd = document.getElementById('moveSpd').value / 1000;
        
        // Vizualizare Bass în Sidebar
        document.getElementById('vuFill').style.width = (bassVal/2.5) + "%";

        const isBassBeat = micActive && (bassVal > sens);
        const time = Date.now() * spd;

        let driftX = fxForced ? (Math.cos(time) * 50) : 0;
        let w = W * 0.9, h = (video.videoHeight / video.videoWidth) * w || W * 1.77;
        let x = (W-w)/2 + driftX, y = (H-h)/2;

        ctx.save();
        
        if (isBassBeat) {
            // EFECT BASS SHAKE (RGB SPLIT)
            let shift = (bassVal / 255) * sInt;
            ctx.globalCompositeOperation = "screen";
            
            // Strat Roșu (ușor stânga)
            renderLayer(res, x + shift, y + (Math.random()-0.5)*shift, w, h, 0.8, "red");
            // Strat Albastru (ușor dreapta)
            renderLayer(res, x - shift, y + (Math.random()-0.5)*shift, w, h, 0.8, "blue");
        } else {
            renderLayer(res, x, y, w, h, 1, "none");
        }

        ctx.restore();
    }

    function renderLayer(res, x, y, w, h, alpha, filterType) {
        ctx.save();
        ctx.globalAlpha = alpha;
        
        // Aplicăm un filtru colorat rapid doar pentru shake
        if(filterType === "red") ctx.filter = "contrast(150%) sepia(100%) hue-rotate(-50deg) saturate(5)";
        if(filterType === "blue") ctx.filter = "contrast(150%) sepia(100%) hue-rotate(180deg) saturate(5)";

        if(aiActive && res.segmentationMask) {
            const t = document.createElement('canvas'); t.width = W; t.height = H;
            const tc = t.getContext('2d');
            tc.drawImage(res.image, x, y, w, h);
            tc.globalCompositeOperation = 'destination-in';
            tc.drawImage(res.segmentationMask, x, y, w, h);
            ctx.drawImage(t, 0, 0);
        } else if (video.readyState >= 2) {
            ctx.drawImage(video, x, y, w, h);
        }
        ctx.restore();
    }

    window.onkeydown = (e) => { if(e.key === 'Enter') fxForced = !fxForced; };
</script>
</body>
</html>
