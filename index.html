<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <title>Shatter V29 - Fullscreen & Smart Hybrid</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/selfie_segmentation.js" crossorigin="anonymous"></script>
    <style>
        :root { --accent: #00d4ff; --bg: #050505; --fx: #ff0050; }
        body { background: var(--bg); color: white; font-family: sans-serif; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        .sidebar { width: 320px; background: #111; border-right: 1px solid #333; padding: 15px; display: flex; flex-direction: column; gap: 10px; overflow-y: auto; z-index: 20; transition: 0.3s; }
        .main { flex-grow: 1; display: flex; justify-content: center; align-items: center; background: #000; position: relative; }
        
        #container { height: 92vh; aspect-ratio: 9/16; border: 2px solid #333; position: relative; background: #000; transition: all 0.5s ease; }
        #container.fullscreen { width: 100vw; height: 100vh; border: none; aspect-ratio: auto; }
        
        canvas { width: 100%; height: 100%; position: absolute; }
        .card { background: #1a1a1a; padding: 12px; border-radius: 8px; border: 1px solid #333; margin-bottom: 5px; }
        h3 { font-size: 10px; margin: 0 0 10px; color: var(--accent); text-transform: uppercase; }
        button { width: 100%; padding: 10px; border-radius: 4px; border: none; font-weight: bold; cursor: pointer; margin-bottom: 5px; }
        .btn-cam { background: #2ed573; } .btn-audio { background: #00d4ff; }
        .btn-fx-toggle { background: #444; color: white; text-transform: uppercase; font-size: 11px; }
        .fx-active { background: var(--fx) !important; box-shadow: 0 0 15px var(--fx); }
        .btn-fs { background: #f1c40f; color: black; position: absolute; top: 10px; right: 10px; z-index: 100; width: auto; padding: 8px 15px; opacity: 1; transition: 0.3s; }
        
        .hide-ui .sidebar { margin-left: -320px; }
        .hide-ui .btn-fs { opacity: 0; }
        
        label { font-size: 10px; color: #888; display: block; margin-top: 5px; }
        input[type="range"], select { width: 100%; background: #222; color: white; border: 1px solid #444; padding: 5px; border-radius: 4px; }
    </style>
</head>
<body id="body">

<div class="sidebar">
    <div class="card">
        <h3>1. ACTIVARE SURSE</h3>
        <button class="btn-cam" onclick="startCamera()">CAMERA OK</button>
        <button class="btn-audio" id="micBtn" onclick="initAudio()">START MICROFON</button>
        <button onclick="aiActive=!aiActive" id="aiBtn">AI CUT-OUT ON/OFF</button>
    </div>

    <div class="card" style="border-left: 3px solid var(--fx)">
        <h3>2. CONTROL FX</h3>
        <button class="btn-fx-toggle" id="fxStatus" onclick="toggleFX()">FORȚEAZĂ EFECTE (ENTER)</button>
        <label>Sensibilitate Microfon</label>
        <input type="range" id="micSens" min="0" max="100" value="25" oninput="saveSet()">
        <label>Mărime Puls</label>
        <input type="range" id="pulsSize" min="0" max="150" value="50" oninput="saveSet()">
        <label>Intensitate Drift</label>
        <input type="range" id="driftInt" min="0" max="300" value="80" oninput="saveSet()">
        <label>Viteza Mișcare</label>
        <input type="range" id="pulsSpeed" min="1" max="100" value="30" oninput="saveSet()">
        <label>Fulgere Margine</label>
        <input type="range" id="lightning" min="0" max="100" value="60" oninput="saveSet()">
    </div>

    <div class="card">
        <h3>3. FUNDAL CHROMA</h3>
        <select id="chromaColor" onchange="saveSet()">
            <option value="#00ff00">Verde (Chroma)</option>
            <option value="#000000">Negru</option>
            <option value="#0000ff">Albastru</option>
        </select>
        <button onclick="localStorage.clear(); location.reload();" style="background:#333; color:#aaa; font-size:9px; margin-top:10px;">RESET MEMORIE</button>
    </div>
</div>

<div class="main" id="mainZone">
    <button class="btn-fs" id="fsBtn" onclick="toggleFullscreen()">FULLSCREEN (F)</button>
    <div id="container"><canvas id="out"></canvas></div>
</div>

<video id="vid" autoplay muted playsinline style="display:none"></video>

<script>
    const video = document.getElementById('vid');
    const canvas = document.getElementById('out');
    const ctx = canvas.getContext('2d');
    let aiActive = false, fxForced = false, micActive = false, hue = 0, isFS = false;
    let audioCtx, analyser, dataArray, uiTimer;
    const W = 1080, H = 1920;

    const selfie = new SelfieSegmentation({locateFile: (f) => `https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/${f}`});
    selfie.setOptions({ modelSelection: 1 });
    selfie.onResults(draw);

    window.onload = () => {
        const saved = JSON.parse(localStorage.getItem('fx_v29_prefs') || '{}');
        for(let id in saved) { if(document.getElementById(id)) document.getElementById(id).value = saved[id]; }
    };

    function saveSet() {
        const settings = {};
        ['micSens','pulsSize','driftInt','pulsSpeed','lightning','chromaColor'].forEach(id => {
            settings[id] = document.getElementById(id).value;
        });
        localStorage.setItem('fx_v29_prefs', JSON.stringify(settings));
    }

    function toggleFullscreen() {
        isFS = !isFS;
        const container = document.getElementById('container');
        const body = document.getElementById('body');
        if(isFS) {
            container.classList.add('fullscreen');
            document.getElementById('fsBtn').innerText = "EXIT FULLSCREEN (ESC)";
        } else {
            container.classList.remove('fullscreen');
            document.getElementById('fsBtn').innerText = "FULLSCREEN (F)";
            body.classList.remove('hide-ui');
        }
    }

    // Auto-hide UI in Fullscreen when mouse is still
    document.addEventListener('mousemove', () => {
        if(!isFS) return;
        document.getElementById('body').classList.remove('hide-ui');
        clearTimeout(uiTimer);
        uiTimer = setTimeout(() => {
            if(isFS) document.getElementById('body').classList.add('hide-ui');
        }, 3000);
    });

    async function startCamera() {
        const s = await navigator.mediaDevices.getUserMedia({ video: { width: 1280, height: 720 } });
        video.srcObject = s;
        video.onloadedmetadata = () => { video.play(); loop(); };
    }

    async function initAudio() {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const s = await navigator.mediaDevices.getUserMedia({ audio: true });
        analyser = audioCtx.createAnalyser(); analyser.fftSize = 128;
        dataArray = new Uint8Array(analyser.frequencyBinCount);
        audioCtx.createMediaStreamSource(s).connect(analyser);
        micActive = true;
        document.getElementById('micBtn').style.background = "#00d4ff";
    }

    function toggleFX() {
        fxForced = !fxForced;
        document.getElementById('fxStatus').classList.toggle('fx-active', fxForced);
    }

    function loop() {
        if (aiActive && video.readyState >= 2) { selfie.send({image: video}); } 
        else { draw({}); }
        requestAnimationFrame(loop);
    }

    function draw(res) {
        canvas.width = W; canvas.height = H;
        ctx.fillStyle = document.getElementById('chromaColor').value;
        ctx.fillRect(0, 0, W, H);
        hue = (hue + 1) % 360;

        let vol = 0;
        if (micActive && analyser) {
            analyser.getByteFrequencyData(dataArray);
            vol = dataArray.reduce((a,b) => a+b) / dataArray.length;
        }

        const mSens = document.getElementById('micSens').value;
        const shouldRun = fxForced || (micActive && vol > mSens);
        const time = Date.now() * (document.getElementById('pulsSpeed').value / 1000);

        let pSize = shouldRun ? (Math.sin(time) * document.getElementById('pulsSize').value) : 0;
        let dInt = shouldRun ? (Math.cos(time * 0.8) * document.getElementById('driftInt').value) : 0;

        let w = (W * 0.9) + pSize, h = ((video.videoHeight / video.videoWidth) * w) + pSize;
        let x = (W-w)/2 + dInt, y = (H-h)/2;

        renderLayer(res, x, y, w, h);

        if(shouldRun) {
            ctx.globalCompositeOperation = "screen";
            for(let i=0; i<5; i++) {
                ctx.save(); ctx.globalAlpha = 0.15;
                ctx.drawImage(video, x + Math.sin(time+i)*dInt, y, w, h);
                ctx.restore();
            }
            if(document.getElementById('lightning').value > 0) drawLightning(x, y, w, h, document.getElementById('lightning').value);
        }
    }

    function drawLightning(x, y, w, h, pwr) {
        ctx.save(); ctx.strokeStyle = `hsl(${hue}, 100%, 75%)`; ctx.lineWidth = pwr / 15; ctx.beginPath();
        let pts = [[x,y], [x+w,y], [x+w,y+h], [x,y+h], [x,y]];
        pts.forEach((p, i) => {
            if(i===0) ctx.moveTo(p[0], p[1]);
            else { for(let s=1; s<=4; s++) {
                ctx.lineTo(pts[i-1][0]+(p[0]-pts[i-1][0])*(s/4)+(Math.random()-0.5)*30, pts[i-1][1]+(p[1]-pts[i-1][1])*(s/4)+(Math.random()-0.5)*30);
            }}
        });
        ctx.stroke(); ctx.restore();
    }

    function renderLayer(res, x, y, w, h) {
        if(aiActive && res.segmentationMask) {
            const t = document.createElement('canvas'); t.width = W; t.height = H;
            const tc = t.getContext('2d');
            tc.drawImage(res.image, x, y, w, h);
            tc.globalCompositeOperation = 'destination-in';
            tc.drawImage(res.segmentationMask, x, y, w, h);
            ctx.drawImage(t, 0, 0);
        } else { ctx.drawImage(video, x, y, w, h); }
    }

    window.onkeydown = (e) => { 
        if(e.key === 'Enter') toggleFX();
        if(e.key === 'f' || e.key === 'F') toggleFullscreen();
        if(e.key === 'Escape' && isFS) toggleFullscreen();
    };
</script>
</body>
</html>
