<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <title>Shatter Sound Reactive V18</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/selfie_segmentation.js" crossorigin="anonymous"></script>
    <style>
        :root { --accent: #00d4ff; --bg: #0a0a0a; --fx: #ff0050; }
        body { background: var(--bg); color: white; font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        .sidebar { width: 300px; background: #111; border-right: 1px solid #333; padding: 15px; display: flex; flex-direction: column; gap: 10px; overflow-y: auto; }
        .main { flex-grow: 1; display: flex; justify-content: center; align-items: center; background: #000; }
        #container { height: 90vh; aspect-ratio: 9/16; position: relative; border: 2px solid #444; }
        canvas { width: 100%; height: 100%; }
        .card { background: #1a1a1a; padding: 12px; border-radius: 8px; border: 1px solid #333; margin-bottom: 10px; }
        h3 { font-size: 11px; margin: 0 0 10px; color: var(--accent); text-transform: uppercase; letter-spacing: 1px; }
        input, button, select { width: 100%; background: #000; border: 1px solid #444; color: white; padding: 8px; border-radius: 4px; font-size: 11px; margin-bottom: 5px; }
        .btn-reset { background: #555 !important; color: white; border: none; cursor: pointer; margin-top: 5px; }
        .btn-reset:hover { background: #ff4757 !important; }
        label { font-size: 10px; color: #888; display: block; margin-top: 5px; }
        .status { font-size: 10px; color: #2ed573; text-align: center; margin-bottom: 10px; }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="status" id="audioStatus">AUDIO: OFF</div>
    
    <div class="card">
        <h3>1. Audio & Camera</h3>
        <button onclick="init()" style="background:#2ed573; color:000; font-weight:bold;">START SESSION</button>
        <select id="audioSource">
            <option value="none">Selectează Microfon / Placă</option>
        </select>
        <button id="toggleAI" onclick="aiActive=!aiActive">AI CUT-OUT: OFF</button>
    </div>

    <div class="card" style="border-left: 3px solid var(--fx);">
        <h3>2. FX Spargere (ENTER / SOUND)</h3>
        <label>Sensibilitate Audio</label>
        <input type="range" id="audioSens" min="0" max="200" value="100">
        
        <label>Distorsiune Shatter</label>
        <input type="range" id="shatterPower" min="0" max="400" value="150">
        
        <label>Nr. Fragmente</label>
        <input type="range" id="shardsCount" min="1" max="20" value="8">
        
        <label>Glow / Contur</label>
        <input type="range" id="glow" min="0" max="100" value="30">
        
        <label>Viteză Mișcare</label>
        <input type="range" id="speed" min="1" max="50" value="15">
        
        <button class="btn-reset" onclick="resetFX()">RESET EFECTE (ZERO)</button>
    </div>
</div>

<div class="main">
    <div id="container">
        <canvas id="out"></canvas>
    </div>
</div>

<video id="vid" autoplay muted playsinline style="display:none"></video>

<script>
    const video = document.getElementById('vid');
    const canvas = document.getElementById('out');
    const ctx = canvas.getContext('2d');
    let aiActive = false, fxActive = false;
    let audioCtx, analyser, dataArray, source;
    const W = 1080, H = 1920;

    const selfie = new SelfieSegmentation({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/${file}`});
    selfie.setOptions({ modelSelection: 1 });
    selfie.onResults(draw);

    function resetFX() {
        document.getElementById('shatterPower').value = 0;
        document.getElementById('shardsCount').value = 1;
        document.getElementById('glow').value = 0;
        document.getElementById('audioSens').value = 100;
        document.getElementById('speed').value = 15;
    }

    async function init() {
        // Init Camera
        const stream = await navigator.mediaDevices.getUserMedia({ video: { width: 1280, height: 720 }, audio: true });
        video.srcObject = stream;
        
        // Init Audio
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        analyser = audioCtx.createAnalyser();
        source = audioCtx.createMediaStreamSource(stream);
        source.connect(analyser);
        analyser.fftSize = 256;
        dataArray = new Uint8Array(analyser.frequencyBinCount);
        
        document.getElementById('audioStatus').innerText = "AUDIO & CAMERA: ACTIV";

        // Get Audio Devices
        const devices = await navigator.mediaDevices.enumerateDevices();
        const select = document.getElementById('audioSource');
        devices.filter(d => d.kind === 'audioinput').forEach(d => {
            const opt = document.createElement('option');
            opt.value = d.deviceId; opt.text = d.label || 'Microfon/Input';
            select.add(opt);
        });

        setInterval(() => { if(video.readyState >= 2) selfie.send({image: video}); }, 40);
    }

    function draw(res) {
        canvas.width = W; canvas.height = H;
        ctx.fillStyle = "#00ff00"; // Chroma
        ctx.fillRect(0, 0, W, H);

        let volume = 0;
        if (analyser) {
            analyser.getByteFrequencyData(dataArray);
            volume = dataArray.reduce((a, b) => a + b) / dataArray.length;
        }

        const sens = document.getElementById('audioSens').value / 100;
        const pwr = document.getElementById('shatterPower').value * (volume/128) * sens;
        const shards = document.getElementById('shardsCount').value;
        const glw = document.getElementById('glow').value;
        const spd = document.getElementById('speed').value;

        let w = W * 0.9;
        let h = (video.videoHeight / video.videoWidth) * w;
        let x = (W - w) / 2;
        let y = (H - h) / 2;

        const time = Date.now() * (spd * 0.001);

        // Dacă apăsăm ENTER sau dacă volumul e mare, activăm Shatter
        if (fxActive || (volume * sens > 30)) {
            for (let i = 0; i < shards; i++) {
                ctx.save();
                ctx.globalAlpha = 0.2;
                const offX = Math.sin(time + i) * pwr;
                const offY = Math.cos(time * 0.8 + i) * (pwr / 2);
                ctx.shadowBlur = glw / 2;
                ctx.shadowColor = "white";
                render(res, x + offX, y + offY, w, h);
                ctx.restore();
            }
        }

        ctx.save();
        if(fxActive || volume * sens > 30) {
            ctx.shadowBlur = glw;
            ctx.shadowColor = "white";
        }
        render(res, x, y, w, h);
        ctx.restore();
    }

    function render(res, x, y, w, h) {
        if (aiActive && res.segmentationMask) {
            const tmp = document.createElement('canvas'); tmp.width = W; tmp.height = H;
            const tCtx = tmp.getContext('2d');
            tCtx.drawImage(res.image, x, y, w, h);
            tCtx.globalCompositeOperation = 'destination-in';
            tCtx.drawImage(res.segmentationMask, x, y, w, h);
            ctx.drawImage(tmp, 0, 0);
        } else if (video.readyState >= 2) {
            ctx.drawImage(video, x, y, w, h);
        }
    }

    window.onkeydown = (e) => { if(e.key === 'Enter') fxActive = !fxActive; };
</script>
</body>
</html>
