<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <title>Shatter Stable V21</title>
    <style>
        :root { --accent: #00d4ff; --bg: #0a0a0a; --fx: #ff0050; }
        body { background: var(--bg); color: white; font-family: sans-serif; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        .sidebar { width: 280px; background: #111; border-right: 1px solid #333; padding: 15px; display: flex; flex-direction: column; gap: 10px; overflow-y: auto; }
        .main { flex-grow: 1; display: flex; justify-content: center; align-items: center; background: #000; position: relative; }
        #container { height: 90vh; aspect-ratio: 9/16; border: 2px solid #444; position: relative; overflow: hidden; }
        canvas { width: 100%; height: 100%; }
        .card { background: #1a1a1a; padding: 12px; border-radius: 8px; border: 1px solid #333; }
        h3 { font-size: 11px; margin: 0 0 10px; color: var(--accent); text-transform: uppercase; }
        button { width: 100%; background: #333; border: 1px solid #444; color: white; padding: 12px; border-radius: 4px; cursor: pointer; font-weight: bold; margin-bottom: 5px; }
        .btn-active { background: #2ed573 !important; color: black; }
        input[type="range"] { width: 100%; margin: 10px 0; }
        label { font-size: 10px; color: #888; display: block; }
        #flash { position: absolute; inset: 0; background: white; opacity: 0; pointer-events: none; z-index: 10; }
    </style>
</head>
<body>

<div id="flash"></div>

<div class="sidebar">
    <div class="card">
        <h3>1. PORNIRE RAPIDĂ</h3>
        <button id="btnStart" onclick="startAll()">START CAMERĂ & AUDIO</button>
        <p style="font-size: 9px; color: #666;">*Se activează microfonul automat pentru puls.</p>
    </div>

    <div class="card" style="border-left: 3px solid var(--fx);">
        <h3>2. CONTROL EFECTE</h3>
        <label>Sensibilitate Microfon</label>
        <input type="range" id="sens" min="0" max="300" value="150">
        
        <label>Putere Shatter (Spargere)</label>
        <input type="range" id="pwr" min="0" max="500" value="200">
        
        <label>Număr Fragmente</label>
        <input type="range" id="shards" min="1" max="15" value="8">
        
        <label>Glow / Contur Alb</label>
        <input type="range" id="glow" min="0" max="100" value="30">
        
        <label>Screen Flash (Bass)</label>
        <input type="range" id="flashPwr" min="0" max="100" value="0">
        
        <button onclick="resetFX()" style="background:#444; font-size:9px; margin-top:10px;">RESET TOTAL</button>
    </div>
    <div style="font-size: 10px; color: #ff0050; text-align: center; margin-top: 20px;">
        APASĂ <b>ENTER</b> PENTRU TEST MANUAL
    </div>
</div>

<div class="main">
    <div id="container">
        <canvas id="out"></canvas>
    </div>
</div>

<video id="v" autoplay muted playsinline style="display:none"></video>

<script>
    const v = document.getElementById('v');
    const canvas = document.getElementById('out');
    const ctx = canvas.getContext('2d');
    const flash = document.getElementById('flash');
    
    let fxManual = false;
    let audioCtx, analyser, dataArray;
    const W = 1080, H = 1920;

    // Funcția principală care pornește totul deodată
    async function startAll() {
        try {
            // Start Video
            const videoStream = await navigator.mediaDevices.getUserMedia({ 
                video: { width: 1280, height: 720 } 
            });
            v.srcObject = videoStream;

            // Start Audio
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
            analyser = audioCtx.createAnalyser();
            analyser.fftSize = 256;
            dataArray = new Uint8Array(analyser.frequencyBinCount);
            audioCtx.createMediaStreamSource(audioStream).connect(analyser);

            document.getElementById('btnStart').classList.add('btn-active');
            document.getElementById('btnStart').innerText = "SISTEM ACTIV";
            
            requestAnimationFrame(update);
        } catch(e) {
            alert("Te rugăm să permiți accesul la cameră și microfon!");
            console.error(e);
        }
    }

    function resetFX() {
        ['sens','pwr','shards','glow','flashPwr'].forEach(id => document.getElementById(id).value = 0);
    }

    function update() {
        canvas.width = W; canvas.height = H;
        
        // Fundal Negru pentru performanță (sau poți pune #00ff00 pentru chroma)
        ctx.fillStyle = "#000"; 
        ctx.fillRect(0, 0, W, H);

        let vol = 0;
        if(analyser) {
            analyser.getByteFrequencyData(dataArray);
            vol = dataArray.reduce((a,b) => a+b) / dataArray.length;
        }

        const sns = document.getElementById('sens').value / 100;
        const p = document.getElementById('pwr').value * (vol/128) * sns;
        const shd = document.getElementById('shards').value;
        const glw = document.getElementById('glow').value;
        const flsh = document.getElementById('flashPwr').value;

        // Flash Effect
        if(vol * sns > 85) flash.style.opacity = flsh / 100;
        else flash.style.opacity = 0;

        // Calcul dimensiuni cameră (central)
        let w = W * 0.9;
        let h = (v.videoHeight / v.videoWidth) * w || W * 1.6;
        let x = (W - w) / 2;
        let y = (H - h) / 2;

        const isActive = fxManual || (vol * sns > 25);

        // Randare Fragmente (Shatter)
        if(isActive && v.readyState >= 2) {
            for(let i = 0; i < shd; i++) {
                ctx.save();
                ctx.globalAlpha = 0.2;
                const tx = Math.sin(Date.now() * 0.01 + i) * p;
                
                if(glw > 0) { ctx.shadowBlur = glw / 2; ctx.shadowColor = "white"; }
                ctx.drawImage(v, x + tx, y, w, h);
                ctx.restore();
            }
        }

        // Randare Cameră Principală
        if(v.readyState >= 2) {
            ctx.save();
            if(isActive && glw > 0) { ctx.shadowBlur = glw; ctx.shadowColor = "white"; }
            ctx.drawImage(v, x, y, w, h);
            ctx.restore();
        }

        requestAnimationFrame(update);
    }

    window.onkeydown = (e) => { if(e.key === 'Enter') fxManual = !fxManual; };
</script>
</body>
</html>
